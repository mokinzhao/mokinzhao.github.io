(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{450:function(t,s,a){"use strict";a.r(s);var n=a(16),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"event-loop-详解"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#event-loop-详解"}},[t._v("#")]),t._v(" Event Loop 详解")]),t._v(" "),a("blockquote",[a("p",[t._v("本文是"),a("a",{attrs:{href:"https://juejin.im/post/5c3d8956e51d4511dc72c200?utm_source=gold_browser_extension#comment",target:"_blank",rel:"noopener noreferrer"}},[t._v("弄懂 Event Loop"),a("OutboundLink")],1),t._v("的删改版，去除了原文中一些容易引起歧义的部分，对一些内容进行了扩充")])]),t._v(" "),a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),a("p",[a("code",[t._v("Event Loop")]),t._v("即事件循环，是指浏览器或"),a("code",[t._v("Node")]),t._v("的一种解决"),a("code",[t._v("javaScript")]),t._v("单线程运行时不会阻塞的一种机制，也就是我们经常使用"),a("strong",[t._v("异步")]),t._v("的原理。\n"),a("a",{attrs:{name:"Kec8C"}})]),t._v(" "),a("h2",{attrs:{id:"为啥要弄懂-event-loop"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#为啥要弄懂-event-loop"}},[t._v("#")]),t._v(" 为啥要弄懂 Event Loop")]),t._v(" "),a("ul",[a("li",[t._v("是要增加自己技术的深度，也就是懂得"),a("code",[t._v("JavaScript")]),t._v("的运行机制。"),a("br")]),t._v(" "),a("li",[t._v("现在在前端领域各种技术层出不穷，掌握底层原理，可以让自己以不变，应万变。"),a("br")]),t._v(" "),a("li",[t._v("应对各大互联网公司的面试，懂其原理，题目任其发挥。"),a("br"),t._v(" "),a("a",{attrs:{name:"52BT4"}})])]),t._v(" "),a("h2",{attrs:{id:"栈、队列的基本概念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#栈、队列的基本概念"}},[t._v("#")]),t._v(" 栈、队列的基本概念")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995437042-9d683636-9bf5-45fb-8cf3-e482b94a707d.webp#align=left&display=inline&height=271&originHeight=271&originWidth=294&size=0&status=done&width=294",alt:""}})]),t._v(" "),a("h3",{attrs:{id:"栈-stack"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#栈-stack"}},[t._v("#")]),t._v(" 栈（Stack）")]),t._v(" "),a("p",[a("strong",[t._v("栈")]),t._v("在计算机科学中是限定仅在"),a("strong",[t._v("表尾")]),t._v("进行"),a("strong",[t._v("插入")]),t._v("或"),a("strong",[t._v("删除")]),t._v("操作的线性表。 "),a("strong",[t._v("栈")]),t._v("是一种数据结构，它按照"),a("strong",[t._v("后进先出")]),t._v("的原则存储数据，"),a("strong",[t._v("先进入")]),t._v("的数据被压入"),a("strong",[t._v("栈底")]),t._v("，"),a("strong",[t._v("最后的数据")]),t._v("在"),a("strong",[t._v("栈顶")]),t._v("，需要读数据的时候从"),a("strong",[t._v("栈顶")]),t._v("开始"),a("strong",[t._v("弹出数据")]),t._v("。"),a("br"),a("strong",[t._v("栈")]),t._v("是只能在"),a("strong",[t._v("某一端插入")]),t._v("和"),a("strong",[t._v("删除")]),t._v("的"),a("strong",[t._v("特殊线性表")]),t._v("。"),a("br"),a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436902-6dcf8420-be5b-4dd9-9fb6-43e567e53c86.webp#align=left&display=inline&height=282&originHeight=282&originWidth=616&size=0&status=done&width=616",alt:""}}),t._v(" "),a("a",{attrs:{name:"Dao1u"}})]),t._v(" "),a("h3",{attrs:{id:"队列-queue"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#队列-queue"}},[t._v("#")]),t._v(" 队列（Queue）")]),t._v(" "),a("p",[t._v("特殊之处在于它只允许在表的前端（"),a("code",[t._v("front")]),t._v("）进行"),a("strong",[t._v("删除")]),t._v("操作，而在表的后端（"),a("code",[t._v("rear")]),t._v("）进行"),a("strong",[t._v("插入")]),t._v("操作，和"),a("strong",[t._v("栈")]),t._v("一样，"),a("strong",[t._v("队列")]),t._v("是一种操作受限制的线性表。"),a("br"),t._v("进行"),a("strong",[t._v("插入")]),t._v("操作的端称为"),a("strong",[t._v("队尾")]),t._v("，进行"),a("strong",[t._v("删除")]),t._v("操作的端称为"),a("strong",[t._v("队头")]),t._v("。 队列中没有元素时，称为"),a("strong",[t._v("空队列")]),t._v("。"),a("br"),a("strong",[t._v("队列")]),t._v("的数据元素又称为"),a("strong",[t._v("队列元素")]),t._v("。在队列中插入一个队列元素称为"),a("strong",[t._v("入队")]),t._v("，从"),a("strong",[t._v("队列")]),t._v("中"),a("strong",[t._v("删除")]),t._v("一个队列元素称为"),a("strong",[t._v("出队")]),t._v("。因为队列"),a("strong",[t._v("只允许")]),t._v("在一端"),a("strong",[t._v("插入")]),t._v("，在另一端"),a("strong",[t._v("删除")]),t._v("，所以只有"),a("strong",[t._v("最早")]),t._v("进入"),a("strong",[t._v("队列")]),t._v("的元素"),a("strong",[t._v("才能最先从队列中")]),t._v("删除，故队列又称为"),a("strong",[t._v("先进先出")]),t._v("（"),a("code",[t._v("FIFO—first in first out")]),t._v("）"),a("br"),a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436932-57cb6ee5-763a-47b2-a0be-4174c4fd1c66.webp#align=left&display=inline&height=270&originHeight=270&originWidth=554&size=0&status=done&width=554",alt:""}}),t._v(" "),a("a",{attrs:{name:"DE6Ak"}})]),t._v(" "),a("h2",{attrs:{id:"event-loop"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#event-loop"}},[t._v("#")]),t._v(" Event Loop")]),t._v(" "),a("p",[t._v("在"),a("code",[t._v("JavaScript")]),t._v("中，任务被分为两种，一种宏任务（"),a("code",[t._v("MacroTask")]),t._v("）也叫"),a("code",[t._v("Task")]),t._v("，一种叫微任务（"),a("code",[t._v("MicroTask")]),t._v("）。\n"),a("a",{attrs:{name:"JQeJU"}})]),t._v(" "),a("h3",{attrs:{id:"macrotask-宏任务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#macrotask-宏任务"}},[t._v("#")]),t._v(" MacroTask（宏任务）")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("script")]),t._v("全部代码、"),a("code",[t._v("setTimeout")]),t._v("、"),a("code",[t._v("setInterval")]),t._v("、"),a("code",[t._v("setImmediate")]),t._v("（浏览器暂时不支持，只有 IE10 支持，具体可见"),a("a",{attrs:{href:"https://link.juejin.im/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWindow%2FsetImmediate",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("MDN")]),a("OutboundLink")],1),t._v("）、"),a("code",[t._v("I/O")]),t._v("、"),a("code",[t._v("UI Rendering")]),t._v("。\n"),a("a",{attrs:{name:"zG8N7"}})])]),t._v(" "),a("h3",{attrs:{id:"microtask-微任务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#microtask-微任务"}},[t._v("#")]),t._v(" MicroTask（微任务）")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("Process.nextTick（Node独有）")]),t._v("、"),a("code",[t._v("Promise")]),t._v("、"),a("code",[t._v("Object.observe(废弃)")]),t._v("、"),a("code",[t._v("MutationObserver")]),t._v("（具体使用方式查看"),a("a",{attrs:{href:"https://link.juejin.im/?target=http%3A%2F%2Fjavascript.ruanyifeng.com%2Fdom%2Fmutationobserver.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),a("OutboundLink")],1),t._v("）\n"),a("a",{attrs:{name:"EvaCF"}})])]),t._v(" "),a("h2",{attrs:{id:"浏览器中的-event-loop"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#浏览器中的-event-loop"}},[t._v("#")]),t._v(" 浏览器中的 Event Loop")]),t._v(" "),a("p",[a("code",[t._v("Javascript")]),t._v("  有一个  "),a("code",[t._v("main thread")]),t._v("  主线程和  "),a("code",[t._v("call-stack")]),t._v("  调用栈(执行栈)，所有的任务都会被放到调用栈等待主线程执行。\n"),a("a",{attrs:{name:"GyyZL"}})]),t._v(" "),a("h3",{attrs:{id:"js-调用栈"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#js-调用栈"}},[t._v("#")]),t._v(" JS 调用栈")]),t._v(" "),a("p",[t._v("JS 调用栈采用的是后进先出的规则，当函数执行的时候，会被添加到栈的顶部，当执行栈执行完成后，就会从栈顶移出，直到栈内被清空。\n"),a("a",{attrs:{name:"Hv5X9"}})]),t._v(" "),a("h3",{attrs:{id:"同步任务和异步任务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#同步任务和异步任务"}},[t._v("#")]),t._v(" 同步任务和异步任务")]),t._v(" "),a("p",[a("code",[t._v("Javascript")]),t._v("单线程任务被分为"),a("strong",[t._v("同步任务")]),t._v("和"),a("strong",[t._v("异步任务")]),t._v("，同步任务会在调用栈中按照顺序等待主线程依次执行，异步任务会在异步任务有了结果后，将注册的回调函数放入任务队列中等待主线程空闲的时候（调用栈被清空），被读取到栈内等待主线程的执行。"),a("br"),a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436925-9ac8fb38-4dfd-4d12-b5fe-c564ede43f80.webp#align=left&display=inline&height=518&originHeight=518&originWidth=636&size=0&status=done&width=636",alt:""}}),t._v("任务队列"),a("code",[t._v("Task Queue")]),t._v("，即队列，是一种先进先出的一种数据结构。"),a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995437021-43545b5b-0a48-475a-a8a6-cce80433fe1a.webp#align=left&display=inline&height=669&originHeight=669&originWidth=800&size=0&status=done&width=800",alt:""}}),t._v(" "),a("a",{attrs:{name:"gn45S"}})]),t._v(" "),a("h3",{attrs:{id:"事件循环的进程模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事件循环的进程模型"}},[t._v("#")]),t._v(" 事件循环的进程模型")]),t._v(" "),a("ul",[a("li",[t._v("选择当前要执行的任务队列，选择任务队列中最先进入的任务，如果任务队列为空即"),a("code",[t._v("null")]),t._v("，则执行跳转到微任务（"),a("code",[t._v("MicroTask")]),t._v("）的执行步骤。")]),t._v(" "),a("li",[t._v("将事件循环中的任务设置为已选择任务。")]),t._v(" "),a("li",[t._v("执行任务。")]),t._v(" "),a("li",[t._v("将事件循环中当前运行任务设置为 null。")]),t._v(" "),a("li",[t._v("将已经运行完成的任务从任务队列中删除。")]),t._v(" "),a("li",[t._v("microtasks 步骤：进入 microtask 检查点。")]),t._v(" "),a("li",[t._v("更新界面渲染。")]),t._v(" "),a("li",[t._v("返回第一步。\n"),a("a",{attrs:{name:"axvjy"}})])]),t._v(" "),a("h3",{attrs:{id:"执行进入-microtask-检查点时-用户代理会执行以下步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#执行进入-microtask-检查点时-用户代理会执行以下步骤"}},[t._v("#")]),t._v(" 执行进入 microtask 检查点时，用户代理会执行以下步骤：")]),t._v(" "),a("ul",[a("li",[t._v("设置 microtask 检查点标志为 true。")]),t._v(" "),a("li",[t._v("当事件循环"),a("code",[t._v("microtask")]),t._v("执行不为空时：选择一个最先进入的"),a("code",[t._v("microtask")]),t._v("队列的"),a("code",[t._v("microtask")]),t._v("，将事件循环的"),a("code",[t._v("microtask")]),t._v("设置为已选择的"),a("code",[t._v("microtask")]),t._v("，运行"),a("code",[t._v("microtask")]),t._v("，将已经执行完成的"),a("code",[t._v("microtask")]),t._v("为"),a("code",[t._v("null")]),t._v("，移出"),a("code",[t._v("microtask")]),t._v("中的"),a("code",[t._v("microtask")]),t._v("。")]),t._v(" "),a("li",[t._v("清理 IndexDB 事务")]),t._v(" "),a("li",[t._v("设置进入 microtask 检查点的标志为 false。")])]),t._v(" "),a("p",[t._v("上述可能不太好理解，下图是我做的一张图片。"),a("br"),a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/gif/128853/1560995436931-71f56a41-54d3-49f3-a382-c1e6acbf301e.gif#align=left&display=inline&height=589&originHeight=589&originWidth=1011&size=0&status=done&width=1011",alt:""}}),a("br"),t._v("执行栈在执行完"),a("strong",[t._v("同步任务")]),t._v("后，查看"),a("strong",[t._v("执行栈")]),t._v("是否为空，如果执行栈为空，就会去检查"),a("strong",[t._v("微任务")]),t._v("("),a("code",[t._v("microTask")]),t._v(")队列是否为空，如果为空的话，就执行"),a("code",[t._v("Task")]),t._v("（宏任务），否则就一次性执行完所有微任务。"),a("br"),t._v("每次单个"),a("strong",[t._v("宏任务")]),t._v("执行完毕后，检查"),a("strong",[t._v("微任务")]),t._v("("),a("code",[t._v("microTask")]),t._v(")队列是否为空，如果不为空的话，会按照"),a("strong",[t._v("先入先")]),t._v("出的规则全部执行完"),a("strong",[t._v("微任务")]),t._v("("),a("code",[t._v("microTask")]),t._v(")后，设置"),a("strong",[t._v("微任务")]),t._v("("),a("code",[t._v("microTask")]),t._v(")队列为"),a("code",[t._v("null")]),t._v("，然后再执行"),a("strong",[t._v("宏任务")]),t._v("，如此循环。\n"),a("a",{attrs:{name:"rd9zs"}})]),t._v(" "),a("h2",{attrs:{id:"举个例子"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#举个例子"}},[t._v("#")]),t._v(" 举个例子")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"script start"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"setTimeout"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nPromise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"promise1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"promise2"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"script end"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br")])]),a("p",[t._v("首先我们划分几个分类：\n"),a("a",{attrs:{name:"Phe8h"}})]),t._v(" "),a("h3",{attrs:{id:"第一次执行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第一次执行"}},[t._v("#")]),t._v(" 第一次执行：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("Tasks：run script、 setTimeout callback\nMicrotasks：Promise then\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JS")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("stack")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" script\n"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("Log")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" script start、script end。\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("执行同步代码，将宏任务（"),a("code",[t._v("Tasks")]),t._v("）和微任务("),a("code",[t._v("Microtasks")]),t._v(")划分到各自队列中。\n"),a("a",{attrs:{name:"GZaz9"}})]),t._v(" "),a("h3",{attrs:{id:"第二次执行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第二次执行"}},[t._v("#")]),t._v(" 第二次执行：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Tasks：run script、 setTimeout callback\nMicrotasks：Promise2 then\nJS stack: Promise2 callback\nLog: script start、script end、promise1、promise2\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("执行宏任务后，检测到微任务("),a("code",[t._v("Microtasks")]),t._v(")队列中不为空，执行"),a("code",[t._v("Promise1")]),t._v("，执行完成"),a("code",[t._v("Promise1")]),t._v("后，调用"),a("code",[t._v("Promise2.then")]),t._v("，放入微任务("),a("code",[t._v("Microtasks")]),t._v(")队列中，再执行"),a("code",[t._v("Promise2.then")]),t._v("。\n"),a("a",{attrs:{name:"6OrDB"}})]),t._v(" "),a("h3",{attrs:{id:"第三次执行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第三次执行"}},[t._v("#")]),t._v(" 第三次执行：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Tasks：setTimeout callback\nMicrotasks：\nJS stack: setTimeout callback\nLog: script start、script end、promise1、promise2、setTimeout\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("当微任务("),a("code",[t._v("Microtasks")]),t._v(")队列中为空时，执行宏任务（"),a("code",[t._v("Tasks")]),t._v("），执行"),a("code",[t._v("setTimeout callback")]),t._v("，打印日志。\n"),a("a",{attrs:{name:"h3YfH"}})]),t._v(" "),a("h3",{attrs:{id:"第四次执行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第四次执行"}},[t._v("#")]),t._v(" 第四次执行：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Tasks：setTimeout callback\nMicrotasks：\nJS stack:\nLog: script start、script end、promise1、promise2、setTimeout\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("清空"),a("strong",[t._v("Tasks")]),t._v("队列和"),a("code",[t._v("JS stack")]),t._v("。"),a("br"),t._v("以上执行帧动画可以查看"),a("a",{attrs:{href:"https://link.juejin.im/?target=https%3A%2F%2Fjakearchibald.com%2F2015%2Ftasks-microtasks-queues-and-schedules%2F",target:"_blank",rel:"noopener noreferrer"}},[t._v("Tasks, microtasks, queues and schedules"),a("OutboundLink")],1),a("br"),t._v("或许这张图也更好理解些。"),a("br"),a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/gif/128853/1560995436968-c6ff2732-4b20-49d4-852f-8c298eeb0d2e.gif#align=left&display=inline&height=341&originHeight=341&originWidth=611&size=0&status=done&width=611",alt:""}}),t._v(" "),a("a",{attrs:{name:"SmhP7"}})]),t._v(" "),a("h2",{attrs:{id:"再举个例子"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#再举个例子"}},[t._v("#")]),t._v(" 再举个例子")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"script start"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("async1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("async2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"async1 end"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("async2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"async2 end"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("async1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"setTimeout"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Promise"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"promise1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"promise2"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"script end"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br")])]),a("p",[t._v("这里需要先理解"),a("code",[t._v("async/await")]),t._v("。"),a("br"),a("code",[t._v("async/await")]),t._v("  在底层转换成了  "),a("code",[t._v("promise")]),t._v("  和  "),a("code",[t._v("then")]),t._v("  回调函数。"),a("br"),t._v("也就是说，这是  "),a("code",[t._v("promise")]),t._v("  的语法糖。"),a("br"),t._v("每次我们使用  "),a("code",[t._v("await")]),t._v(", 解释器都创建一个  "),a("code",[t._v("promise")]),t._v("  对象，然后把剩下的  "),a("code",[t._v("async")]),t._v("  函数中的操作放到  "),a("code",[t._v("then")]),t._v("  回调函数中。"),a("br"),a("code",[t._v("async/await")]),t._v("  的实现，离不开  "),a("code",[t._v("Promise")]),t._v("。从字面意思来理解，"),a("code",[t._v("async")]),t._v("  是“异步”的简写，而  "),a("code",[t._v("await")]),t._v("  是  "),a("code",[t._v("async wait")]),t._v("  的简写可以认为是等待异步方法执行完成。\n"),a("a",{attrs:{name:"LRx9h"}})]),t._v(" "),a("h3",{attrs:{id:"关于-73-以下版本和-73-版本的区别"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关于-73-以下版本和-73-版本的区别"}},[t._v("#")]),t._v(" "),a("strong",[t._v("关于 73 以下版本和 73 版本的区别")])]),t._v(" "),a("ul",[a("li",[t._v("在老版本版本以下，先执行"),a("code",[t._v("promise1")]),t._v("和"),a("code",[t._v("promise2")]),t._v("，再执行"),a("code",[t._v("async1")]),t._v("。")]),t._v(" "),a("li",[t._v("在 73 版本，先执行"),a("code",[t._v("async1")]),t._v("再执行"),a("code",[t._v("promise1")]),t._v("和"),a("code",[t._v("promise2")]),t._v("。")])]),t._v(" "),a("p",[a("strong",[t._v("主要原因是因为在谷歌(金丝雀)73 版本中更改了规范，如下图所示：")]),a("br"),a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436973-49daab42-3959-4cb2-9417-30a651fedf80.webp#align=left&display=inline&height=243&originHeight=243&originWidth=668&size=0&status=done&width=668",alt:""}})]),t._v(" "),a("ul",[a("li",[t._v("区别在于"),a("code",[t._v("RESOLVE(thenable)")]),t._v("和之间的区别"),a("code",[t._v("Promise.resolve(thenable)")]),t._v("。\n"),a("a",{attrs:{name:"lE9S0"}})])]),t._v(" "),a("h3",{attrs:{id:"在老版本中"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在老版本中"}},[t._v("#")]),t._v(" "),a("strong",[t._v("在老版本中")])]),t._v(" "),a("ul",[a("li",[t._v("首先，传递给  "),a("code",[t._v("await")]),t._v("  的值被包裹在一个  "),a("code",[t._v("Promise")]),t._v("  中。然后，处理程序附加到这个包装的  "),a("code",[t._v("Promise")]),t._v("，以便在  "),a("code",[t._v("Promise")]),t._v("  变为  "),a("code",[t._v("fulfilled")]),t._v("  后恢复该函数，并且暂停执行异步函数，一旦  "),a("code",[t._v("promise")]),t._v("  变为  "),a("code",[t._v("fulfilled")]),t._v("，恢复异步函数的执行。")]),t._v(" "),a("li",[t._v("每个  "),a("code",[t._v("await")]),t._v("  引擎必须创建两个额外的 Promise（即使右侧已经是一个  "),a("code",[t._v("Promise")]),t._v("）并且它需要至少三个  "),a("code",[t._v("microtask")]),t._v("  队列  "),a("code",[t._v("ticks")]),t._v("（"),a("code",[t._v("tick")]),t._v("为系统的相对时间单位，也被称为系统的时基，来源于定时器的周期性中断（输出脉冲），一次中断表示一个"),a("code",[t._v("tick")]),t._v("，也被称做一个“时钟滴答”、时标。）。\n"),a("a",{attrs:{name:"1I6ks"}})])]),t._v(" "),a("h3",{attrs:{id:"引用贺老师知乎上的一个例子"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#引用贺老师知乎上的一个例子"}},[t._v("#")]),t._v(" "),a("strong",[t._v("引用贺老师知乎上的一个例子")])]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("f")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" p"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ok"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("简化理解为：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("f")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("RESOLVE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("p"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ok"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("ul",[a("li",[t._v("如果  "),a("code",[t._v("RESOLVE(p)")]),t._v("  对于  "),a("code",[t._v("p")]),t._v("  为  "),a("code",[t._v("promise")]),t._v("  直接返回  "),a("code",[t._v("p")]),t._v("  的话，那么  "),a("code",[t._v("p")]),t._v("的  "),a("code",[t._v("then")]),t._v("  方法就会被马上调用，其回调就立即进入  "),a("code",[t._v("job")]),t._v("  队列。")]),t._v(" "),a("li",[t._v("而如果  "),a("code",[t._v("RESOLVE(p)")]),t._v("  严格按照标准，应该是产生一个新的  "),a("code",[t._v("promise")]),t._v("，尽管该  "),a("code",[t._v("promise")]),t._v("确定会  "),a("code",[t._v("resolve")]),t._v("  为  "),a("code",[t._v("p")]),t._v("，但这个过程本身是异步的，也就是现在进入  "),a("code",[t._v("job")]),t._v("  队列的是新  "),a("code",[t._v("promise")]),t._v("的  "),a("code",[t._v("resolve")]),t._v("过程，所以该  "),a("code",[t._v("promise")]),t._v("  的  "),a("code",[t._v("then")]),t._v("  不会被立即调用，而要等到当前  "),a("code",[t._v("job")]),t._v("  队列执行到前述  "),a("code",[t._v("resolve")]),t._v("  过程才会被调用，然后其回调（也就是继续  "),a("code",[t._v("await")]),t._v("  之后的语句）才加入  "),a("code",[t._v("job")]),t._v("  队列，所以时序上就晚了。\n"),a("a",{attrs:{name:"XRpkE"}})])]),t._v(" "),a("h3",{attrs:{id:"谷歌-金丝雀-73-版本中"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#谷歌-金丝雀-73-版本中"}},[t._v("#")]),t._v(" "),a("strong",[t._v("谷歌（金丝雀）73 版本中")])]),t._v(" "),a("ul",[a("li",[t._v("使用对"),a("code",[t._v("PromiseResolve")]),t._v("的调用来更改"),a("code",[t._v("await")]),t._v("的语义，以减少在公共"),a("code",[t._v("awaitPromise")]),t._v("情况下的转换次数。")]),t._v(" "),a("li",[t._v("如果传递给  "),a("code",[t._v("await")]),t._v("  的值已经是一个  "),a("code",[t._v("Promise")]),t._v("，那么这种优化避免了再次创建  "),a("code",[t._v("Promise")]),t._v("  包装器，在这种情况下，我们从最少三个  "),a("code",[t._v("microtick")]),t._v("  到只有一个  "),a("code",[t._v("microtick")]),t._v("。\n"),a("a",{attrs:{name:"kbGWS"}})])]),t._v(" "),a("h3",{attrs:{id:"详细过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#详细过程"}},[t._v("#")]),t._v(" "),a("strong",[t._v("详细过程：")])]),t._v(" "),a("p",[a("strong",[t._v("73 以下版本")])]),t._v(" "),a("ul",[a("li",[t._v("首先，打印"),a("code",[t._v("script start")]),t._v("，调用"),a("code",[t._v("async1()")]),t._v("时，返回一个"),a("code",[t._v("Promise")]),t._v("，所以打印出来"),a("code",[t._v("async2 end")]),t._v("。")]),t._v(" "),a("li",[t._v("每个  "),a("code",[t._v("await")]),t._v("，会新产生一个"),a("code",[t._v("promise")]),t._v(",但这个过程本身是异步的，所以该"),a("code",[t._v("await")]),t._v("后面不会立即调用。")]),t._v(" "),a("li",[t._v("继续执行同步代码，打印"),a("code",[t._v("Promise")]),t._v("和"),a("code",[t._v("script end")]),t._v("，将"),a("code",[t._v("then")]),t._v("函数放入"),a("strong",[t._v("微任务")]),t._v("队列中等待执行。")]),t._v(" "),a("li",[t._v("同步执行完成之后，检查"),a("strong",[t._v("微任务")]),t._v("队列是否为"),a("code",[t._v("null")]),t._v("，然后按照先入先出规则，依次执行。")]),t._v(" "),a("li",[t._v("然后先执行打印"),a("code",[t._v("promise1")]),t._v(",此时"),a("code",[t._v("then")]),t._v("的回调函数返回"),a("code",[t._v("undefinde")]),t._v("，此时又有"),a("code",[t._v("then")]),t._v("的链式调用，又放入"),a("strong",[t._v("微任务")]),t._v("队列中，再次打印"),a("code",[t._v("promise2")]),t._v("。")]),t._v(" "),a("li",[t._v("再回到"),a("code",[t._v("await")]),t._v("的位置执行返回的  "),a("code",[t._v("Promise")]),t._v("  的  "),a("code",[t._v("resolve")]),t._v("  函数，这又会把  "),a("code",[t._v("resolve")]),t._v("  丢到微任务队列中，打印"),a("code",[t._v("async1 end")]),t._v("。")]),t._v(" "),a("li",[t._v("当"),a("strong",[t._v("微任务")]),t._v("队列为空时，执行宏任务,打印"),a("code",[t._v("setTimeout")]),t._v("。")])]),t._v(" "),a("p",[a("strong",[t._v("谷歌（金丝雀 73 版本）")])]),t._v(" "),a("ul",[a("li",[t._v("如果传递给  "),a("code",[t._v("await")]),t._v("  的值已经是一个  "),a("code",[t._v("Promise")]),t._v("，那么这种优化避免了再次创建  "),a("code",[t._v("Promise")]),t._v("  包装器，在这种情况下，我们从最少三个  "),a("code",[t._v("microtick")]),t._v("  到只有一个  "),a("code",[t._v("microtick")]),t._v("。")]),t._v(" "),a("li",[t._v("引擎不再需要为  "),a("code",[t._v("await")]),t._v("  创造  "),a("code",[t._v("throwaway Promise")]),t._v(" - 在绝大部分时间。")]),t._v(" "),a("li",[t._v("现在  "),a("code",[t._v("promise")]),t._v("  指向了同一个  "),a("code",[t._v("Promise")]),t._v("，所以这个步骤什么也不需要做。然后引擎继续像以前一样，创建  "),a("code",[t._v("throwaway Promise")]),t._v("，安排  "),a("code",[t._v("PromiseReactionJob")]),t._v("  在  "),a("code",[t._v("microtask")]),t._v("  队列的下一个  "),a("code",[t._v("tick")]),t._v("  上恢复异步函数，暂停执行该函数，然后返回给调用者。")])]),t._v(" "),a("p",[t._v("具体详情查看（"),a("a",{attrs:{href:"https://link.juejin.im/?target=https%3A%2F%2Fv8.js.cn%2Fblog%2Ffast-async%2F",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),a("OutboundLink")],1),t._v("）。\n"),a("a",{attrs:{name:"lXMku"}})]),t._v(" "),a("h2",{attrs:{id:"nodejs-的-event-loop"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nodejs-的-event-loop"}},[t._v("#")]),t._v(" NodeJS 的 Event Loop")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436966-ae34b24c-83d0-4472-8854-1552abd9fcdb.webp#align=left&display=inline&height=223&originHeight=223&originWidth=543&size=0&status=done&width=543",alt:""}}),a("br"),a("code",[t._v("Node")]),t._v("中的"),a("code",[t._v("Event Loop")]),t._v("是基于"),a("code",[t._v("libuv")]),t._v("实现的，而"),a("code",[t._v("libuv")]),t._v("是  "),a("code",[t._v("Node")]),t._v("  的新跨平台抽象层，libuv 使用异步，事件驱动的编程方式，核心是提供"),a("code",[t._v("i/o")]),t._v("的事件循环和异步回调。libuv 的"),a("code",[t._v("API")]),t._v("包含有时间，非阻塞的网络，异步文件操作，子进程等等。 "),a("code",[t._v("Event Loop")]),t._v("就是在"),a("code",[t._v("libuv")]),t._v("中实现的。"),a("br"),a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436946-e5bcfbd1-340e-4c68-a14e-cd000081eef4.webp#align=left&display=inline&height=442&originHeight=442&originWidth=745&size=0&status=done&width=745",alt:""}}),t._v(" "),a("a",{attrs:{name:"4clmy"}})]),t._v(" "),a("h3",{attrs:{id:"node的event-loop一共分为-6-个阶段-每个细节具体如下"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node的event-loop一共分为-6-个阶段-每个细节具体如下"}},[t._v("#")]),t._v(" "),a("code",[t._v("Node")]),t._v("的"),a("code",[t._v("Event loop")]),t._v("一共分为 6 个阶段，每个细节具体如下：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("timers")]),t._v(": 执行"),a("code",[t._v("setTimeout")]),t._v("和"),a("code",[t._v("setInterval")]),t._v("中到期的"),a("code",[t._v("callback")]),t._v("。")]),t._v(" "),a("li",[a("code",[t._v("pending callback")]),t._v(": 上一轮循环中少数的"),a("code",[t._v("callback")]),t._v("会放在这一阶段执行。")]),t._v(" "),a("li",[a("code",[t._v("idle, prepare")]),t._v(": 仅在内部使用。")]),t._v(" "),a("li",[a("code",[t._v("poll")]),t._v(": 最重要的阶段，执行"),a("code",[t._v("pending callback")]),t._v("，在适当的情况下回阻塞在这个阶段。")]),t._v(" "),a("li",[a("code",[t._v("check")]),t._v(": 执行"),a("code",[t._v("setImmediate")]),t._v("("),a("code",[t._v("setImmediate()")]),t._v("是将事件插入到事件队列尾部，主线程和事件队列的函数执行完成之后立即执行"),a("code",[t._v("setImmediate")]),t._v("指定的回调函数)的"),a("code",[t._v("callback")]),t._v("。")]),t._v(" "),a("li",[a("code",[t._v("close callbacks")]),t._v(": 执行"),a("code",[t._v("close")]),t._v("事件的"),a("code",[t._v("callback")]),t._v("，例如"),a("code",[t._v("socket.on('close'[,fn])")]),t._v("或者"),a("code",[t._v("http.server.on('close, fn)")]),t._v("。")])]),t._v(" "),a("p",[t._v("具体细节如下：\n"),a("a",{attrs:{name:"qYgPm"}})]),t._v(" "),a("h3",{attrs:{id:"timers"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#timers"}},[t._v("#")]),t._v(" timers")]),t._v(" "),a("p",[t._v("执行"),a("code",[t._v("setTimeout")]),t._v("和"),a("code",[t._v("setInterval")]),t._v("中到期的"),a("code",[t._v("callback")]),t._v("，执行这两者回调需要设置一个毫秒数，理论上来说，应该是时间一到就立即执行 callback 回调，但是由于"),a("code",[t._v("system")]),t._v("的调度可能会延时，达不到预期时间。"),a("br"),t._v("以下是官网文档解释的例子：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fs"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("someAsyncOperation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("callback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Assume this takes 95ms to complete")]),t._v("\n  fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/path/to/file"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" timeoutScheduled "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" delay "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" timeoutScheduled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("delay"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("ms have passed since I was scheduled")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// do someAsyncOperation which takes 95 ms to complete")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("someAsyncOperation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" startCallback "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// do something that will take 10ms...")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" startCallback "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// do nothing")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br")])]),a("p",[t._v("当进入事件循环时，它有一个空队列（"),a("code",[t._v("fs.readFile()")]),t._v("尚未完成），因此定时器将等待剩余毫秒数，当到达 95ms 时，"),a("code",[t._v("fs.readFile()")]),t._v("完成读取文件并且其完成需要 10 毫秒的回调被添加到轮询队列并执行。"),a("br"),t._v("当回调结束时，队列中不再有回调，因此事件循环将看到已达到最快定时器的"),a("strong",[t._v("阈值")]),t._v("，然后回到"),a("strong",[t._v("timers 阶段")]),t._v("以执行定时器的回调。"),a("br"),t._v("在此示例中，您将看到正在调度的计时器与正在执行的回调之间的总延迟将为 105 毫秒。"),a("br"),a("strong",[t._v("以下是我测试时间：")]),a("br"),a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436982-2f817b92-3c4a-4d4c-8f95-92f63efa336c.webp#align=left&display=inline&height=430&originHeight=430&originWidth=724&size=0&status=done&width=724",alt:""}}),t._v(" "),a("a",{attrs:{name:"sLxqs"}})]),t._v(" "),a("h3",{attrs:{id:"pending-callbacks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pending-callbacks"}},[t._v("#")]),t._v(" pending callbacks")]),t._v(" "),a("p",[t._v("此阶段执行某些系统操作（例如 TCP 错误类型）的回调。 例如，如果"),a("code",[t._v("TCP socket ECONNREFUSED")]),t._v("在尝试 connect 时 receives，则某些* nix 系统希望等待报告错误。 这将在"),a("code",[t._v("pending callbacks")]),t._v("阶段执行。\n"),a("a",{attrs:{name:"3rwhp"}})]),t._v(" "),a("h3",{attrs:{id:"poll"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#poll"}},[t._v("#")]),t._v(" poll")]),t._v(" "),a("p",[a("strong",[t._v("该 poll 阶段有两个主要功能：")])]),t._v(" "),a("ul",[a("li",[t._v("执行"),a("code",[t._v("I/O")]),t._v("回调。")]),t._v(" "),a("li",[t._v("处理轮询队列中的事件。")])]),t._v(" "),a("p",[a("strong",[t._v("当事件循环进入"),a("code",[t._v("poll")]),t._v("阶段并且在"),a("code",[t._v("timers")]),t._v("中没有可以执行定时器时，将发生以下两种情况之一")])]),t._v(" "),a("ul",[a("li",[t._v("如果"),a("code",[t._v("poll")]),t._v("队列不为空，则事件循环将遍历其同步执行它们的"),a("code",[t._v("callback")]),t._v("队列，直到队列为空，或者达到"),a("code",[t._v("system-dependent")]),t._v("（系统相关限制）。")])]),t._v(" "),a("p",[a("strong",[t._v("如果"),a("code",[t._v("poll")]),t._v("队列为空，则会发生以下两种情况之一")])]),t._v(" "),a("ul",[a("li",[t._v("如果有"),a("code",[t._v("setImmediate()")]),t._v("回调需要执行，则会立即停止执行"),a("code",[t._v("poll")]),t._v("阶段并进入执行"),a("code",[t._v("check")]),t._v("阶段以执行回调。"),a("br")]),t._v(" "),a("li",[t._v("如果没有"),a("code",[t._v("setImmediate()")]),t._v("回到需要执行，poll 阶段将等待"),a("code",[t._v("callback")]),t._v("被添加到队列中，然后立即执行。"),a("br")])]),t._v(" "),a("p",[a("strong",[t._v("当然设定了 timer 的话且 poll 队列为空，则会判断是否有 timer 超时，如果有的话会回到 timer 阶段执行回调。")]),t._v(" "),a("a",{attrs:{name:"aZTtj"}})]),t._v(" "),a("h3",{attrs:{id:"check"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#check"}},[t._v("#")]),t._v(" check")]),t._v(" "),a("p",[a("strong",[t._v("此阶段允许人员在 poll 阶段完成后立即执行回调。")]),a("br"),t._v("如果"),a("code",[t._v("poll")]),t._v("阶段闲置并且"),a("code",[t._v("script")]),t._v("已排队"),a("code",[t._v("setImmediate()")]),t._v("，则事件循环到达 check 阶段执行而不是继续等待。"),a("br"),a("code",[t._v("setImmediate()")]),t._v("实际上是一个特殊的计时器，它在事件循环的一个单独阶段运行。它使用"),a("code",[t._v("libuv API")]),t._v("来调度在"),a("code",[t._v("poll")]),t._v("阶段完成后执行的回调。"),a("br"),t._v("通常，当代码被执行时，事件循环最终将达到"),a("code",[t._v("poll")]),t._v("阶段，它将等待传入连接，请求等。"),a("br"),t._v("但是，如果已经调度了回调"),a("code",[t._v("setImmediate()")]),t._v("，并且轮询阶段变为空闲，则它将结束并且到达"),a("code",[t._v("check")]),t._v("阶段，而不是等待"),a("code",[t._v("poll")]),t._v("事件。")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"start"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"timer1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  Promise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"promise1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"timer2"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  Promise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"promise2"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nPromise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"promise3"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"end"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br")])]),a("p",[t._v("如果"),a("code",[t._v("node")]),t._v("版本为"),a("code",[t._v("v11.x")]),t._v("， 其结果与浏览器一致。")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("start\nend\npromise3\ntimer1\npromise1\ntimer2\npromise2\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("p",[t._v("具体详情可以查看《"),a("a",{attrs:{href:"https://juejin.im/post/5c3e8d90f265da614274218a",target:"_blank",rel:"noopener noreferrer"}},[t._v("又被 node 的 eventloop 坑了，这次是 node 的锅"),a("OutboundLink")],1),t._v("》。"),a("br"),t._v("如果 v10 版本上述结果存在两种情况：")]),t._v(" "),a("ul",[a("li",[t._v("如果 time2 定时器已经在执行队列中了")])]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("start\nend\npromise3\ntimer1\ntimer2\npromise1\npromise2\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("ul",[a("li",[t._v("如果 time2 定时器没有在执行对列中，执行结果为")])]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("start\nend\npromise3\ntimer1\npromise1\ntimer2\npromise2\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("p",[t._v("具体情况可以参考"),a("code",[t._v("poll")]),t._v("阶段的两种情况。"),a("br"),t._v("从下图可能更好理解："),a("br"),a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/gif/128853/1560995436960-165cb65c-477f-4b4c-8a0a-79d3136f342e.gif#align=left&display=inline&height=333&originHeight=333&originWidth=598&size=0&status=done&width=598",alt:""}}),t._v(" "),a("a",{attrs:{name:"K0Wcv"}})]),t._v(" "),a("h2",{attrs:{id:"setimmediate-的-settimeout-的区别"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#setimmediate-的-settimeout-的区别"}},[t._v("#")]),t._v(" setImmediate() 的 setTimeout()的区别")]),t._v(" "),a("p",[a("strong",[a("code",[t._v("setImmediate")]),t._v("和"),a("code",[t._v("setTimeout()")]),t._v("是相似的，但根据它们被调用的时间以不同的方式表现。")])]),t._v(" "),a("ul",[a("li",[a("code",[t._v("setImmediate()")]),t._v("设计用于在当前"),a("code",[t._v("poll")]),t._v("阶段完成后 check 阶段执行脚本 。")]),t._v(" "),a("li",[a("code",[t._v("setTimeout()")]),t._v("  安排在经过最小（ms）后运行的脚本，在"),a("code",[t._v("timers")]),t._v("阶段执行。\n"),a("a",{attrs:{name:"k9uIW"}})])]),t._v(" "),a("h3",{attrs:{id:"举个例子-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#举个例子-2"}},[t._v("#")]),t._v(" 举个例子")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("setTimeout(() => {\n  console.log('timeout');\n}, 0);\nsetImmediate(() => {\n  console.log('immediate');\n});\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[a("strong",[t._v("执行定时器的顺序将根据调用它们的上下文而有所不同。 如果从主模块中调用两者，那么时间将受到进程性能的限制。")]),a("br"),a("strong",[t._v("其结果也不一致")]),a("br"),a("strong",[t._v("如果在"),a("code",[t._v("I / O")]),t._v("周期内移动两个调用，则始终首先执行立即回调：")])]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fs"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nfs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"timeout"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setImmediate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"immediate"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br")])]),a("p",[t._v("其结果可以确定一定是"),a("code",[t._v("immediate => timeout")]),t._v("。"),a("br"),t._v("主要原因是在"),a("code",[t._v("I/O阶段")]),t._v("读取文件后，事件循环会先进入"),a("code",[t._v("poll")]),t._v("阶段，发现有"),a("code",[t._v("setImmediate")]),t._v("需要执行，会立即进入"),a("code",[t._v("check")]),t._v("阶段执行"),a("code",[t._v("setImmediate")]),t._v("的回调。"),a("br"),t._v("然后再进入"),a("code",[t._v("timers")]),t._v("阶段，执行"),a("code",[t._v("setTimeout")]),t._v("，打印"),a("code",[t._v("timeout")]),t._v("。")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("┌───────────────────────────┐\n┌─>│           timers          │\n│  └─────────────┬─────────────┘\n│  ┌─────────────┴─────────────┐\n│  │     pending callbacks     │\n│  └─────────────┬─────────────┘\n│  ┌─────────────┴─────────────┐\n│  │       idle, prepare       │\n│  └─────────────┬─────────────┘      ┌───────────────┐\n│  ┌─────────────┴─────────────┐      │   incoming:   │\n│  │           poll            │<─────┤  connections, │\n│  └─────────────┬─────────────┘      │   data, etc.  │\n│  ┌─────────────┴─────────────┐      └───────────────┘\n│  │           check           │\n│  └─────────────┬─────────────┘\n│  ┌─────────────┴─────────────┐\n└──┤      close callbacks      │\n   └───────────────────────────┘\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br")])]),a("p",[a("a",{attrs:{name:"YOs2k"}})]),t._v(" "),a("h2",{attrs:{id:"process-nexttick"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#process-nexttick"}},[t._v("#")]),t._v(" Process.nextTick()")]),t._v(" "),a("p",[a("strong",[a("code",[t._v("process.nextTick()")]),t._v("虽然它是异步 API 的一部分，但未在图中显示。这是因为"),a("code",[t._v("process.nextTick()")]),t._v("从技术上讲，它不是事件循环的一部分。")])]),t._v(" "),a("ul",[a("li",[a("code",[t._v("process.nextTick()")]),t._v("方法将  "),a("code",[t._v("callback")]),t._v("  添加到"),a("code",[t._v("next tick")]),t._v("队列。 一旦当前事件轮询队列的任务全部完成，在"),a("code",[t._v("next tick")]),t._v("队列中的所有"),a("code",[t._v("callbacks")]),t._v("会被依次调用。")])]),t._v(" "),a("p",[a("strong",[t._v("换种理解方式：")])]),t._v(" "),a("ul",[a("li",[t._v("当每个阶段完成后，如果存在  "),a("code",[t._v("nextTick")]),t._v("  队列，就会清空队列中的所有回调函数，并且优先于其他  "),a("code",[t._v("microtask")]),t._v("  执行。\n"),a("a",{attrs:{name:"GCX3J"}})])]),t._v(" "),a("h3",{attrs:{id:"例子"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#例子"}},[t._v("#")]),t._v(" 例子")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" bar"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"setTimeout"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setImmediate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"setImmediate"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("someAsyncApiCall")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("callback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextTick")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("callback"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("someAsyncApiCall")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"bar"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" bar"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nbar "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br")])]),a("p",[t._v("在 NodeV10 中上述代码执行可能有两种答案，一种为：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("bar 1\nsetTimeout\nsetImmediate\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("另一种为：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("bar 1\nsetImmediate\nsetTimeout\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("无论哪种，始终都是先执行"),a("code",[t._v("process.nextTick(callback)")]),t._v("，打印"),a("code",[t._v("bar 1")]),t._v("。")]),t._v(" "),a("hr")])}),[],!1,null,null,null);s.default=e.exports}}]);